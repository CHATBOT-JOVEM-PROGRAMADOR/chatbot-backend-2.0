<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FALA BOT - Assistente Inteligente</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Language Selector - Canto Superior Esquerdo -->
    <div class="language-selector">
        <label id="language-label">Idioma:</label>
        <select id="language-select" onchange="setLanguage(this.value)">
            <option value="pt">üáßüá∑ Portugu√™s</option>
            <option value="en">üá∫üá∏ English</option>
            <option value="es">üá™üá∏ Espa√±ol</option>
        </select>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen">
        <h1 class="welcome-title" id="welcome-title">FALA BOT</h1>
        <p class="welcome-subtitle" id="welcome-subtitle">
            Seu assistente inteligente para informa√ß√µes sobre o Programa Jovem Programador. 
            Clique no bot√£o de chat para come√ßar a conversar!
        </p>
        
        <div class="welcome-features">
            <div class="feature-card">
                <div class="feature-icon">ü§ñ</div>
                <div class="feature-title" id="feature-ai-title">Assistente IA</div>
                <div class="feature-description" id="feature-ai-desc">
                    Powered by Google Gemini para respostas precisas e contextuais
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">üåç</div>
                <div class="feature-title" id="feature-lang-title">Multil√≠ngue</div>
                <div class="feature-description" id="feature-lang-desc">
                    Suporte para Portugu√™s, Ingl√™s e Espanhol
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">üí¨</div>
                <div class="feature-title" id="feature-chat-title">Chat Intuitivo</div>
                <div class="feature-description" id="feature-chat-desc">
                    Interface moderna e responsiva para melhor experi√™ncia
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Chat Button - Canto Superior Direito -->
    <button id="chat-button" class="chat-button" onclick="toggleChat()">
        <img src="{{ url_for('static', filename='chat.png') }}" alt="Chat">
    </button>

    <!-- Chat Container -->
    <div id="chat-container" class="chat-container">
        <div class="chat-header">
            <h2 id="chat-title">FALA BOT</h2>
            <div class="chat-controls">
                <button class="control-btn" onclick="toggleChat()" title="Fechar">√ó</button>
            </div>
        </div>
        
        <div id="chat-box"></div>
        
        <form id="chat-form">
            <input type="text" id="pergunta" placeholder="Digite sua pergunta..." autocomplete="off" required>
            <button type="submit" id="send-button">Enviar</button>
        </form>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='translations.js') }}"></script>
    <script>
        let chatOpen = false;
        let isLoading = false;

        function toggleChat() {
            const container = document.getElementById('chat-container');
            const button = document.getElementById('chat-button');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                container.classList.add('active');
                button.classList.add('active');
                updateChatButtonTitle();
                // Focus on input when chat opens
                setTimeout(() => {
                    document.getElementById('pergunta').focus();
                }, 400);
            } else {
                container.classList.remove('active');
                button.classList.remove('active');
                updateChatButtonTitle();
            }
        }

        function updateChatButtonTitle() {
            const button = document.getElementById('chat-button');
            const t = translations[currentLanguage()];
            button.title = chatOpen ? t.closeChat : t.openChat;
        }

        // Chat functionality
        const form = document.getElementById('chat-form');
        const chatBox = document.getElementById('chat-box');
        
        form.onsubmit = async (e) => {
            e.preventDefault();
            
            if (isLoading) return;
            
            const pergunta = document.getElementById('pergunta').value.trim();
            
            if (!pergunta) return;
            
            isLoading = true;
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            
            const t = translations[currentLanguage()];
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'user';
            userMessage.innerHTML = `
                <b>${t.userLabel}</b>
                <div class="message-content">${escapeHtml(pergunta)}</div>
            `;
            chatBox.appendChild(userMessage);
            
            // Clear input
            document.getElementById('pergunta').value = '';
            
            // Add loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'bot';
            loadingMessage.id = 'loading-message';
            loadingMessage.innerHTML = `
                <b>${t.botLabel}</b>
                <div class="message-content">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            `;
            chatBox.appendChild(loadingMessage);
            
            // Scroll to bottom
            chatBox.scrollTop = chatBox.scrollHeight;
            
            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pergunta})
                });
                
                if (!resp.ok) {
                    throw new Error(`HTTP error! status: ${resp.status}`);
                }
                
                const data = await resp.json();
                
                // Remove loading message
                const loadingEl = document.getElementById('loading-message');
                if (loadingEl) {
                    chatBox.removeChild(loadingEl);
                }
                
                // Add bot response
                const botMessage = document.createElement('div');
                botMessage.className = 'bot';
                botMessage.innerHTML = `
                    <b>${t.botLabel}</b>
                    <div class="message-content">${escapeHtml(data.resposta || 'Desculpe, n√£o recebi uma resposta v√°lida.')}</div>
                `;
                chatBox.appendChild(botMessage);
                
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                
                // Remove loading message
                const loadingEl = document.getElementById('loading-message');
                if (loadingEl) {
                    chatBox.removeChild(loadingEl);
                }
                
                // Add error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'bot';
                errorMessage.innerHTML = `
                    <b>${t.botLabel}</b>
                    <div class="message-content">${t.errorMessage || 'Desculpe, ocorreu um erro. Tente novamente.'}</div>
                `;
                chatBox.appendChild(errorMessage);
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                // Scroll to bottom
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        };

        // Utility function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeLanguage();
        });

        // Handle Enter key in input
        document.getElementById('pergunta').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isLoading) {
                e.preventDefault();
                form.dispatchEvent(new Event('submit'));
            }
        });

        // Close chat when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('chat-container');
            const button = document.getElementById('chat-button');
            
            if (chatOpen && !container.contains(e.target) && !button.contains(e.target)) {
                toggleChat();
            }
        });

        // Prevent chat from closing when clicking inside
        document.getElementById('chat-container').addEventListener('click', function(e) {
            e.stopPropagation();
        });
    </script>
</body>
</html>